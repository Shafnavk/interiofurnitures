{% extends 'base.html' %}
{% load static %}
{% block content %}

<br>
<br>
<section class="section-content padding-y bg">
  <div class="container">

    <!-- ============================ COMPONENT 1 ================================= -->
    <h4 class="text-center mb-10">Make Payment</h4>
    <br>
    
    <div class="row">

      <aside class="col-lg-8">
        <div class="card">
          <h5 class="card-header">Billing Address</h5>
          <div class="card-body">
            <p class="card-text mb-0">{{order.full_name}}</p>
            <p class="card-text mb-0">{{order.address_line_1}} {{order.address_line_2}}</p>
            <p class="card-text mb-0">{{order.city}}, {{order.state}}</p>
            <p class="card-text mb-0">{{order.country}} - {{order.pincode}}</p>
            {% if order.order_note %}
            <b>Order Note: {{order.order_note}}</b>
            {% endif %}
          </div>
        </div>

        <div class="card mt-3">
          <h5 class="card-header">Payment Method</h5>
          <div class="card-body">
            <p class="card-text">Please select your preferred payment method below:</p>
          </div>
        </div>
        
      </aside> <!-- col.// -->
      <aside class="col-lg-4">

        <div class="card">
          <div class="card-body">
            <dl class="dlist-align">
              <dt>Total price:</dt>
              <dd class="text-right">Rs. {{total}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Tax:</dt>
              <dd class="text-right">Rs. {{tax}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Coupon Discount:</dt>
              {% if discount_amount > 0 %}
              <dd class="text-right">Rs. {{ discount_amount }}</dd>
              {% else %}
              <dd class="text-right">Rs. 0</dd>
              {% endif %}
            </dl>
            <dl class="dlist-align">
              <dt>Grand Total:</dt>
              <dd class="text-right text-dark b"><strong>Rs. {{ grand_total }}</strong></dd>
            </dl>
            <hr>
            <p class="text-center mb-3">
              <img src="{% static './image/misc/payments.png' %}" height="26" alt="Payment methods">
            </p>
           
            <div id="paypal-button-container">
              <!-- PayPal button will load here -->
            </div>
            
            <!-- Wallet Payment Option -->
            <h5 class="card-header text-center mt-3">OR</h5>
            <button id="wallet-payment-btn" class="btn btn-primary btn-block mt-3 mb-3">Pay with Wallet</button>
            <div id="wallet-payment-message" class="text-center"></div>
            
            <h5 class="card-header text-center">OR</h5>
            <br>
            <a href="{% url 'confirm_cod' order.order_number %}" class="btn btn-black btn-block mb-3"> Cash On Delivery</a>
            
          </div> <!-- card-body.// -->
        </div> <!-- card.// -->

      </aside> <!-- col.// -->

    </div> <!-- row.// -->

    <!-- ============================ COMPONENT 1 END .// ================================= -->

  </div> <!-- container .//  -->
</section>

<!-- Add this script after including the PayPal SDK -->
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Use grand_total instead of final_total
  var amount = "{{ grand_total }}";
  var url = "{% url 'payments' %}";
  var csrftoken = getCookie('csrftoken');
  var orderID = "{{ order.order_number }}";
  var payment_method = 'PayPal';
  var redirect_url = "{% url 'order_complete' %}";
  
  paypal.Buttons({
    style: {
      label: 'checkout',  // checkout | credit | pay | buynow | generic
      size: 'responsive', // small | medium | large | responsive
      shape: 'rect',      // pill | rect
      color: 'blue'       // gold | blue | silver | black
    },

    createOrder: function(data, actions) {
      // This function sets up the details of the transaction
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: amount // Set the transaction amount here
          }
        }]
      });
    },
    
    onApprove: function(data, actions) {
      // This function captures the transaction when it is approved
      return actions.order.capture().then(function(details) {
        // Show processing message
        document.getElementById('paypal-button-container').innerHTML = '<div class="alert alert-info text-center">Processing your payment... Please wait.</div>';
        
        sendData();
        function sendData(){
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({
              order_number: orderID,
              transID: details.id,
              payment_method: payment_method,
              payment_status: details.status,
            }),
          })
          .then((response) => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then((data) => {
            window.location.href = redirect_url + '?order_number=' + data.order_number + '&payment_id=' + data.transaction_id;
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('paypal-button-container').innerHTML = 
              '<div class="alert alert-danger">There was a problem processing your payment. Please try again or contact support.</div>';
          });
        }
      });
    },
    
    onError: function(err) {
      console.error('PayPal error:', err);
      document.getElementById('paypal-button-container').innerHTML = 
        '<div class="alert alert-danger">There was a problem with PayPal. Please try again later.</div>';
    }
  }).render('#paypal-button-container');

  // Wallet Payment Processing
  document.getElementById('wallet-payment-btn').addEventListener('click', function() {
    // Show processing message
    document.getElementById('wallet-payment-message').innerHTML = '<div class="alert alert-info text-center">Processing wallet payment... Please wait.</div>';
    
    // Create form data
    const formData = new FormData();
    formData.append('order_number', orderID);
    formData.append('csrfmiddlewaretoken', csrftoken);
    
    // Send request to wallet payment endpoint
    fetch("{% url 'wallet_payment' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": csrftoken,
      },
    })
    .then((response) => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Payment failed');
        });
      }
      return response.json();
    })
    .then((data) => {
      window.location.href = redirect_url + '?order_number=' + data.order_number + '&payment_method=Wallet';
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('wallet-payment-message').innerHTML = 
        '<div class="alert alert-danger">' + error.message + '</div>';
    });
  });
</script>

{% endblock content %}